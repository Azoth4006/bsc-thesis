{% macro op_symbol(op) -%}
    {%- set op = (op or '')|lower -%}
    {%- if op == 'and' -%}&&
    {%- elif op == 'or' -%}||
    {%- elif op == 'plus' -%}+
    {%- elif op == 'minus' -%}-
    {%- elif op == 'lessThan' -%}<
    {%- elif op == 'greaterThan' -%}>
    {%- elif op == 'greaterThanOrEqualTo' -%}>=
    {%- elif op == 'lessThanOrEqualTo' -%}<=
    {%- elif op == 'equals' -%}==
    {%- endif -%}
{%- endmacro %}

{% macro op_prec(op) -%}
    {%- set op = (op or '')|lower -%}
    {%- if op == 'if' -%}0
    {%- elif op == 'or' -%}1
    {%- elif op == 'and' -%}2
    {%- elif op in ['lessThan','greaterThan','greaterThanOrEqualTo','lessThanOrEqualTo','equals'] -%}3
    {%- elif op in ['plus','minus'] -%}4
    {%- elif op == 'not' -%}6
    {%- else -%}5
    {%- endif -%}
{%- endmacro %}

{% macro frame_label(frame_id, frames) -%}
    {%- for f in frames -%}
        {%- if f.id == frame_id -%}{{ f.label }}{%- endif -%}
    {%- endfor -%}
{%- endmacro %}

{% macro render_condition(node, frames, parent_op=None) -%}
    {%- set children = node.children or [] -%}
    {%- set op = (node.operatorToJoinChildren or '')|lower -%}

    {%- if children|length == 0 -%}
        {%- set expr -%}[{{ frame_label(node.frame, frames) }}]{%- endset -%}

    {%- elif op == 'not' and children|length == 1 -%}
        {%- set inner -%}{{ render_condition(children[0], frames, 'not') }}{%- endset -%}
        {%- set expr -%}!({{ inner }}){%- endset -%}

    {%- elif op == 'if' and children|length == 2 -%}
        {%- set a -%}{{ render_condition(children[0], frames, 'or') }}{%- endset -%}
        {%- set b -%}{{ render_condition(children[1], frames, 'or') }}{%- endset -%}
        {%- set expr -%}(!( {{ a }} ) || {{ b }}){%- endset -%}

    {%- elif children|length == 1 -%}
        {%- set expr -%}{{ render_condition(children[0], frames, parent_op) }}{%- endset -%}

    {%- else -%}
        {%- set ns = namespace(s=render_condition(children[0], frames, op)) -%}
        {%- for child in children[1:] -%}
            {%- set ns.s = ns.s ~ ' ' ~ op_symbol(op) ~ ' ' ~ render_condition(child, frames, op) -%}
        {%- endfor -%}
        {%- set expr -%}{{ ns.s }}{%- endset -%}
    {%- endif -%}

    {%- set need_parens = false -%}
    {%- if parent_op is not none and children|length > 1 -%}
        {%- if (op_prec(op)|int) < (op_prec(parent_op)|int) -%}
            {%- set need_parens = true -%}
        {%- endif -%}
    {%- endif -%}

    {%- if need_parens -%}({{ expr }}){%- else -%}{{ expr }}{%- endif -%}
{%- endmacro %}
